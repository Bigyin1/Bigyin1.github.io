---
layout: post
title: О терминалах, консолях и командных оболочках
date: 2022-08-02
---


1. TOC
{:toc}

## Полезные ссылки

1. [Старая, но часто цитируемая статья](http://www.linusakesson.net/programming/tty/)
2. Linux API. Исчерпывающее руководство. Керриск Майкл. - отдельная глава о терминалах.
3. [Учебная ОС xv6](https://pdos.csail.mit.edu/6.828) и осбенно [книга](https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf) по ней. 


Мои дальнейшие заметки здесь являются, по большей части, подробным пересказом вышеприведенных ресурсов. Сначала Я расскажу о работе обыч


## Немного важной истории

Сегодня с помощью клавиатуры, мыши и графического интерфейса Мы легко можем отдавать команды компьютеру - для нас это тривиальные действия. Но в 40-50х годах в распоряжении инженеров(основных пользователей ими же созданных компьютеров) не было ни мониторов, ни мышей, ни даже клавиатур как таковых. Как же тогда обычным пользователям взаимодействовать с компьютером не прибегая к трудозатратному вводу/выводу с помощью перфокарт? Решение оказалось совсем рядом, ведь клавиатура на самом деле уже была, правда в составе другого устройсва - печатной машинки. Какая удача, ведь вместе с клавиатурой мы сразу в комплекте получаем и лист бумаги, который может служит средой для выводв информации(свого рода монитором). Осталось лише слегка передалать нашу машинку и подключить ее компьютеру(далее расскажу что именно изменилось). Такая подключенная к компьютеру машинка получила два названия, которые и по сей день вносят сумятицу в компьютерную терминологию:

- Первое и наиболее часто используемое - терминал. В английском слово terminal означает некую сущность на которой все заканчивается. В русском языке это отразилось в словосочетании "терминал аэропорта", ведь это место является конечным пунктом для рейса. Дабы не придумывать еще одно подобное слово, точку отправления рейса также называют терминалом. Лист в нашей печатной машинке как раз и является той самой конечной точкой для данных, а клавиатура точкой отправления данных.

- Второе - консоль. Здесь все интереснее и запутаннее. В общем случае слово console означает некий пульт управления, но так исторически сложилось, что консолью называли не любую печатную машинку, а только те с которых можно было осуществлять управление системой в целом(настройка, включение/выключение). Это была уже не маленькая печатная машинка, а [целый стенд с кучей кнопок](https://en.wikipedia.org/wiki/System_console), то есть консоль - это главный терминал компьютера(да, к древним компьютерам могло быть подключено сразу много терминалов). Со временем такие отдельно стоящие пульты управления исчезли, и все стало управляться с обычной клавиатуры, но название осталось. Им стали называть и обычные терминалы. На мой взгляд это вносит немалую путаницу в терминологию, поэтому далее я буду использовать только первое именование - `терминал`.

- На самом деле есть еще и третье - [телетайп](https://ru.wikipedia.org/wiki/%D0%A2%D0%B5%D0%BB%D0%B5%D1%82%D0%B0%D0%B9%D0%BF), так называлась такая машинка будучи подкюченной не к компьютеру, а к другой такой машинке. Именно это устройство и было взято за основу инженерами при создании первых терминалов.


Очевидно, что с листом бумаги в качестве монитора на многое раасчитывать не приходится, и с развитием электроники он был заменен на [экран](https://vt100.net/dec/vt_history). Интерсно то, что этот экран был текстовым, то есть мог отображать лишь определенный набор символов, управлять цветом отдельных пикселей было нельзя. По сути это та же печатная машинка, но с текстовым дисплеем вместо бумаги. Очевидным преимуществом является возможность стирать произвольный символ. Такой механизм уже напрямую назывался терминалом.

С исторей пока все, далее опишу как же осуществляется взаимодействие терминала с компьютером.

## Терминал и Компьютер

Сначала в общих чертах рассмотрим их взаимодействие, а затем подробнее разберём происходящее в терминале и ОС компьютера.
Без схем теперь не разобраться:

![Phys Terminal](/assets/img/posts/term/phys_term.png)

### Рассмотрим блок Hardware:

Здесь схематично изображено подключение терминала к компьютеру. UART на схеме - это разъем в компьютере для подключения терминала, т.е терминал и компьютер взаимодействуют по `протоколу` UART. Это один из первых протоколов передачи данных физического уровня. В каком-то смысле это далёкий предок современного USB. Именно с помощью UART порта(также называемого Serial port) к старым компьютерам подключались терминалы, принтеры и даже другие компьютеры. Если не вдаваться в детали, то схема его работы очень проста: последовательная передача байтов в одну и в другую стороны. Так, например, нажатие кнопки на клавиатуре терминала приводит к отправке одного или нескольких байт в UART порт, а ОС компьютера может аналогично отправлять байты терминалу. То какие именно байты летают между терминалом и компьютером, расскажу позже.

Небольшое отсупление о протоколах и реализациях: выше Я упомянул сначала `протокол` UART, а затем UART порт. Протокол представляет собой описание схемы взаимодейтсвия,т.е это совего рода инмтрукция согласно которой мы должны организоввывать связь. UART порт - это реализация этого протокола с помощью микросхемы, управляющей передачей сигнала пр проводу. Подробнее можно прочиать [здесь](https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter).

 
### Теперь к блоку Software:

Будем рассматривать происходящее, предполагая, что компьютер находится под управление ОС семейсва Unix. Примеры будут на языке C.

Начнём с того, как пользовательскому процессу организовать доступ к терминалу.
Печатая что-либо на клавиатуре терминала терминала мы, очевидно, хотим передать некие данные некой программе. Как же программа сможет получить эти данные и записывать на экран терминала выходные данные? 

Для взаимодействия с обычным файлом, мы  должны "открыть" его в нашем процессе, получив файловый дескриптор:
```
int fd = open ("/path/to/file", flags)
```
 Затем с его помощью можно производить операции над файлом в нашем процессе. При попытке, например, записи/чтения ОС поймет, что операции производятся над обычным(т.е находящимся на диске) файлом и с помощью драйвера диска выполнит запрос. Хорошо было бы организовать подобную схему для взаимодействия и с терминалом. В ОС семейтсва Unix именно так и делают. 

Здесь Я не буду подробно описывать детали реализации(о них можно почитать в вышеупомянутой книге Керриска или xv6 book), скажу лишь то, что для терминала и других переферийных устройств ОС создаёт специальные `файлы устройств`, при взаимодействии с таким файлом(точнее с его файловым дескриптором) ОС использует соответсвующий драйвер устройства для взаимодействия. Файлы терминалов традиционно называются `tty`(опционально с каким-нибудь постфиксом). Это сокращение от слова teletype - выше Я не зря упоминал связь названий "телетайп" и "терминал". Такие файлы можно в изобили найти в директории /dev.

Теперь обратим внимание на пунктирный прямоугольник. В нем перечислены части операционной системы, служащие для взаимодействия пользовательских процессов и терминала:

UART driver - это программа с помощью которой можно осуществлять чтение и запись в UART порт, а так как на другом конце UART-линии находится терминал, то это будут чтения/записи терминала. Также драйвер может позволять настраивать UART, например устанавливать скорость передачи и другие никоуровневые параметры. Пример такого драйвера из учебной ОС xv6: [тык](https://github.com/Bigyin1/xv6-riscv-fall19/blob/xv6-riscv-fall19/kernel/uart.c).


Казалось бы, драйвер UART предоставляет вполне достаточный набор функций - чтение и запись байтов, но создетели ОС Unix решили добавить еще один слой - специальный драйвер терминала, значильно расширяющий базовую функциональность. Именно он обрабатывает вызовы read/write для файловых дескрипторов терминалов(также еще есть вызов ioctl, с помощью которого осуществляется настройка драйвера). Далее мы увидим какие преимущества дало такое решение.

На схеме представлены блоки TTY driver и `Line discipline` - здесь выделены отдельно, но фактически Line discipline или дисциплина линии является непосредственной частью драйвера терминала, более того она составляет основу самого драйвера. Я точно не знаю от чего пошло столь странное название, поэтому просто скажу, что он особым образом обрабатывает байты, полученные(с помощью вышеописанного драйвера UART) от терминала. Подробный разбор схемы работы дисциплины линии(т.е драйвера терминала) будет позже.








